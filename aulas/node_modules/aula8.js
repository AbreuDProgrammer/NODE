var net = require('net');
var cons = []; // array de clientes conectados
var broadcast = function(msg, origem){
    cons.forEach(function(con){
        if(con === origem)
            return;
        con.write(msg);
    });
}
net.createServer(function(con){
    cons.push(con);
    con.write("Servidor ativo.");
    con.on('data', function(msg){
        var comando = msg.toString();
        console.log("cmd->"+comando);
        if(comando.indexOf('#name') === 0){
            var nome = comando.replace('#name','');
            broadcast(con.nome+" Ã© "+nome);
            con.nome = nome;
            return;
        }
        else if(comando.indexOf("/sair") === 0){

        }
        else
        { 
            broadcast(con.nome+':'+msg,con);
        }
    });
    con.on('end', function(){
        broadcast(con.nome+' saiu ', con);
        cons.splice(cons.indexOf(con), 1);
    });
    con.on('error', e => console.log(e.toString()));
}).listen(2412);